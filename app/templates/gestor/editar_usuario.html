{% extends 'shared/base.html' %}

{% block title %}Editar Usu√°rio{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>‚úèÔ∏è Editar Usu√°rio</h2>
    <a href="{{ url_for('gestor.usuarios') }}" class="btn btn-outline-secondary">
        ‚Üê Voltar aos Usu√°rios
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Editar Dados do Usu√°rio</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-12 text-center mb-4">
                            <div class="mb-3">
                                <img src="{{ usuario.foto_url or '/static/uploads/avatars/default-avatar.png' }}" 
                                     alt="Foto do Usu√°rio" 
                                     class="rounded-circle border"
                                     style="width: 100px; height: 100px; object-fit: cover;"
                                     id="preview-foto">
                            </div>
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto de Perfil</label>
                                <input type="file" class="form-control" id="foto" name="foto" 
                                       accept="image/*" onchange="previewFoto(this)">
                                <small class="form-text text-muted">
                                    Formatos aceitos: JPG, PNG, GIF (m√°x. 2MB)
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nome" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" id="nome" name="nome" 
                                       value="{{ usuario.nome }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">E-mail *</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ usuario.email }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_usuario" class="form-label">Tipo de Usu√°rio *</label>
                                <select class="form-control" id="tipo_usuario" name="tipo_usuario" required>
                                    <option value="agente" {% if usuario.tipo_usuario == 'agente' %}selected{% endif %}>
                                        Agente
                                    </option>
                                    <option value="gestor" {% if usuario.tipo_usuario == 'gestor' %}selected{% endif %}>
                                        Gestor
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="ativo" name="ativo" 
                                           {% if usuario.ativo %}checked{% endif %}>
                                    <label class="form-check-label" for="ativo">
                                        <strong>Usu√°rio Ativo</strong>
                                    </label>
                                    <br><small class="text-muted">Usu√°rios inativos n√£o conseguem fazer login</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cadastrado em</label>
                                <input type="text" class="form-control" 
                                       value="{{ usuario.created_at.strftime('%d/%m/%Y %H:%M') }}" readonly>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">√öltima atualiza√ß√£o</label>
                                <input type="text" class="form-control" 
                                       value="{{ usuario.updated_at.strftime('%d/%m/%Y %H:%M') if usuario.updated_at else 'Nunca' }}" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <a href="{{ url_for('gestor.usuarios') }}" class="btn btn-secondary">
                            ‚ùå Cancelar
                        </a>
                        {% if usuario.id != session.user_id %}
                        <button type="button" class="btn btn-danger ms-auto" onclick="resetarSenha()">
                            üîë Resetar Senha
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üìä Estat√≠sticas do Usu√°rio</h6>
            </div>
            <div class="card-body">
                {% if usuario.tipo_usuario == 'agente' %}
                <div class="row text-center">
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h5 class="text-primary mb-0">{{ estatisticas.total_pesquisas or 0 }}</h5>
                                <small>Pesquisas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h5 class="text-success mb-0">{{ estatisticas.pesquisas_respondidas or 0 }}</h5>
                                <small>Respondidas</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if estatisticas.total_pesquisas and estatisticas.total_pesquisas > 0 %}
                <div class="mt-3">
                    {% set taxa = (estatisticas.pesquisas_respondidas * 100 / estatisticas.total_pesquisas) %}
                    <small class="text-muted">Taxa de resposta:</small>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-{% if taxa >= 70 %}success{% elif taxa >= 50 %}warning{% else %}danger{% endif %}" 
                             style="width: {{ taxa }}%">
                            {{ "%.1f"|format(taxa) }}%
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted">Gestores t√™m acesso completo ao sistema</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">‚ö†Ô∏è A√ß√µes Importantes</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li>üîÑ Alterar tipo de usu√°rio muda as permiss√µes</li>
                    <li>üö´ Desativar usu√°rio impede o login</li>
                    <li>üîë Resetar senha gera nova senha tempor√°ria</li>
                    <li>üìß Usu√°rio ser√° notificado das altera√ß√µes</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewFoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            document.getElementById('preview-foto').src = e.target.result;
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

function resetarSenha() {
    const nomeUsuario = document.getElementById('nome').value;
    
    if (confirm(`Tem certeza que deseja resetar a senha do usu√°rio "${nomeUsuario}"?\n\nUma nova senha tempor√°ria ser√° gerada e enviada por e-mail.`)) {
        fetch(`/gestor/usuarios/{{ usuario.id }}/resetar-senha`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Senha resetada com sucesso!\nNova senha tempor√°ria: ${data.nova_senha}\n\nInforme ao usu√°rio para alterar no primeiro login.`);
            } else {
                alert('Erro ao resetar senha: ' + data.error);
            }
        })
        .catch(error => {
            alert('Erro de comunica√ß√£o: ' + error.message);
        });
    }
}

// Valida√ß√£o do formul√°rio
document.querySelector('form').addEventListener('submit', function(e) {
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (nome.length < 3) {
        alert('Nome deve ter pelo menos 3 caracteres');
        e.preventDefault();
        return;
    }
    
    if (!email.includes('@') || !email.includes('.')) {
        alert('E-mail deve ter formato v√°lido');
        e.preventDefault();
        return;
    }
    
    // Verificar tamanho da foto
    const foto = document.getElementById('foto');
    if (foto.files && foto.files[0]) {
        if (foto.files[0].size > 2 * 1024 * 1024) { // 2MB
            alert('Foto deve ter no m√°ximo 2MB');
            e.preventDefault();
            return;
        }
    }
});
</script>
{% endblock %}